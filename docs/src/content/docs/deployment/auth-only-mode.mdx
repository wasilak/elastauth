---
title: Authentication-Only Mode
description: Deploy elastauth with Traefik forward authentication
---

import { Tabs, TabItem } from '@astrojs/starlight/components';
import { Steps } from '@astrojs/starlight/components';
import { Card, CardGrid } from '@astrojs/starlight/components';
import { Badge } from '@astrojs/starlight/components';
import { LinkCard } from '@astrojs/starlight/components';

<Badge text="Default Mode" variant="tip" />

Authentication-only mode is elastauth's default operating mode, designed to work seamlessly with reverse proxies like Traefik using the forward authentication pattern.

## Overview

In this mode, elastauth validates authentication and returns authorization headers. The reverse proxy (Traefik) handles the actual proxying to Elasticsearch.

### Architecture

```mermaid
graph LR
    Client[Client] --> Traefik1[Traefik<br/>Proxy]
    Traefik1 --> elastauth[elastauth<br/>Auth]
    elastauth --> Traefik2[Traefik<br/>Proxy]
    Traefik2 --> ES[Elasticsearch]
    
    Traefik1 -.Forward Auth.-> elastauth
    
    style elastauth fill:#e1f5e1
    style Traefik1 fill:#e3f2fd
    style Traefik2 fill:#e3f2fd
```

### Request Flow

<Steps>

1. Client sends request to Traefik
2. Traefik forwards authentication headers to elastauth (forward auth middleware)
3. elastauth validates authentication with configured provider (Authelia/OIDC)
4. elastauth creates or updates Elasticsearch user with appropriate roles
5. elastauth returns `Authorization` header to Traefik
6. Traefik forwards original request to Elasticsearch with injected auth header
7. Elasticsearch processes request and returns response
8. Traefik forwards response to client

</Steps>

## When to Use

<CardGrid>
  <Card title="✅ Existing Infrastructure" icon="puzzle">
    You already use Traefik or another reverse proxy
  </Card>
  <Card title="✅ Advanced Features" icon="setting">
    You need routing, load balancing, or middleware
  </Card>
  <Card title="✅ Multi-Service" icon="list-format">
    You protect multiple services with the same proxy
  </Card>
  <Card title="✅ Centralized TLS" icon="approve-check">
    You want centralized TLS termination
  </Card>
</CardGrid>

## Configuration

### elastauth Configuration

<Tabs syncKey="config-format">
  <TabItem label="YAML">
    ```yaml
    # Proxy mode disabled (default)
    proxy:
      enabled: false

    # Authentication provider
    auth_provider: "authelia"

    # Elasticsearch connection
    elasticsearch:
      hosts: ["https://elasticsearch:9200"]
      username: "elastic"
      password: "changeme"

    # Security
    secret_key: "your-64-char-hex-key"
    default_roles: ["kibana_user"]

    # Cache for performance
    cache:
      type: "redis"
      redis_host: "redis:6379"
      expiration: "1h"

    # Server settings
    listen: "0.0.0.0:5000"
    log_level: "info"
    ```
  </TabItem>
  <TabItem label="Environment Variables">
    ```bash
    # Core settings
    ELASTAUTH_AUTH_PROVIDER=authelia
    ELASTAUTH_SECRET_KEY=your-64-char-hex-key
    ELASTAUTH_LISTEN=0.0.0.0:5000

    # Elasticsearch
    ELASTAUTH_ELASTICSEARCH_USERNAME=elastic
    ELASTAUTH_ELASTICSEARCH_PASSWORD=changeme

    # Cache
    ELASTAUTH_CACHE_TYPE=redis
    ELASTAUTH_CACHE_REDIS_HOST=redis:6379
    ELASTAUTH_CACHE_EXPIRATION=1h
    ```
  </TabItem>
</Tabs>

## Traefik Integration

### Traefik Middleware Configuration

<Tabs syncKey="traefik-config">
  <TabItem label="Static Config (traefik.yml)">
    ```yaml
    entryPoints:
      web:
        address: ":80"
      websecure:
        address: ":443"

    providers:
      file:
        filename: /etc/traefik/dynamic-config.yml
        watch: true

    api:
      dashboard: true
      insecure: true

    log:
      level: INFO
    ```
  </TabItem>
  <TabItem label="Dynamic Config (dynamic-config.yml)">
    ```yaml
    http:
      middlewares:
        # elastauth forward auth middleware
        elastauth:
          forwardAuth:
            address: "http://elastauth:5000/"
            trustForwardHeader: true
            authResponseHeaders:
              - "Authorization"
        
        # Optional: Chain with Authelia
        authelia:
          forwardAuth:
            address: "http://authelia:9091/api/verify?rd=https://auth.example.com"
            trustForwardHeader: true
            authResponseHeaders:
              - "Remote-User"
              - "Remote-Groups"
              - "Remote-Email"
              - "Remote-Name"
        
        # Middleware chain: Authelia → elastauth
        auth-chain:
          chain:
            middlewares:
              - authelia
              - elastauth

      routers:
        # Elasticsearch/Kibana router
        elasticsearch:
          rule: "Host(`kibana.example.com`)"
          entryPoints:
            - websecure
          middlewares:
            - auth-chain
          service: elasticsearch
          tls:
            certResolver: letsencrypt

      services:
        elasticsearch:
          loadBalancer:
            servers:
              - url: "https://elasticsearch:9200"
    ```
  </TabItem>
</Tabs>

### Docker Compose Example

```yaml
version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.file.filename=/etc/traefik/dynamic-config.yml"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic-config.yml:/etc/traefik/dynamic-config.yml:ro
      - ./certs:/certs:ro
    networks:
      - elastauth-net

  authelia:
    image: authelia/authelia:latest
    volumes:
      - ./authelia:/config
    environment:
      - TZ=UTC
    networks:
      - elastauth-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.rule=Host(`auth.example.com`)"
      - "traefik.http.routers.authelia.entrypoints=websecure"
      - "traefik.http.routers.authelia.tls=true"

  elastauth:
    image: ghcr.io/wasilak/elastauth:latest
    environment:
      - ELASTAUTH_AUTH_PROVIDER=authelia
      - ELASTAUTH_SECRET_KEY=${ELASTAUTH_SECRET_KEY}
      - ELASTAUTH_ELASTICSEARCH_USERNAME=elastic
      - ELASTAUTH_ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - ELASTAUTH_CACHE_TYPE=redis
      - ELASTAUTH_CACHE_REDIS_HOST=redis:6379
    volumes:
      - ./config.yml:/app/config.yml:ro
    networks:
      - elastauth-net
    depends_on:
      - redis
      - elasticsearch

  redis:
    image: redis:7-alpine
    networks:
      - elastauth-net

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
    networks:
      - elastauth-net
    volumes:
      - es-data:/usr/share/elasticsearch/data

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    environment:
      - ELASTICSEARCH_HOSTS=https://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=${KIBANA_PASSWORD}
    networks:
      - elastauth-net
    depends_on:
      - elasticsearch
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.kibana.rule=Host(`kibana.example.com`)"
      - "traefik.http.routers.kibana.entrypoints=websecure"
      - "traefik.http.routers.kibana.middlewares=auth-chain"
      - "traefik.http.routers.kibana.tls=true"
      - "traefik.http.services.kibana.loadbalancer.server.port=5601"

networks:
  elastauth-net:
    driver: bridge

volumes:
  es-data:
```

## Chaining with Authelia

elastauth works seamlessly with Authelia in a middleware chain:

### Middleware Chain Flow

```mermaid
graph LR
    Request[Request] --> Traefik
    Traefik --> Authelia
    Authelia --> elastauth
    elastauth --> Traefik2[Traefik]
    Traefik2 --> ES[Elasticsearch]
    
    style Authelia fill:#fff3e0
    style elastauth fill:#e1f5e1
```

<Steps>

1. **Traefik** receives the request
2. **Authelia** validates user authentication (session, 2FA, etc.)
3. **Authelia** adds user headers (`Remote-User`, `Remote-Groups`, etc.)
4. **elastauth** receives request with Authelia headers
5. **elastauth** creates/updates Elasticsearch user
6. **elastauth** returns `Authorization` header
7. **Traefik** forwards request to Elasticsearch with auth header

</Steps>

### Authelia Configuration

In your Authelia `configuration.yml`:

```yaml
access_control:
  default_policy: deny
  rules:
    - domain: kibana.example.com
      policy: two_factor
      subject:
        - "group:admins"
        - "group:users"
```

### Traefik Middleware Chain

```yaml
http:
  middlewares:
    authelia:
      forwardAuth:
        address: "http://authelia:9091/api/verify?rd=https://auth.example.com"
        trustForwardHeader: true
        authResponseHeaders:
          - "Remote-User"
          - "Remote-Groups"
          - "Remote-Email"
          - "Remote-Name"
    
    elastauth:
      forwardAuth:
        address: "http://elastauth:5000/"
        trustForwardHeader: true
        authResponseHeaders:
          - "Authorization"
    
    auth-chain:
      chain:
        middlewares:
          - authelia
          - elastauth
```

## Testing

### Test Authentication Endpoint

<Tabs syncKey="test-method">
  <TabItem label="With Authelia Headers">
    ```bash
    # Test with Authelia headers
    curl -H "Remote-User: testuser" \
         -H "Remote-Groups: admins,users" \
         -H "Remote-Email: test@example.com" \
         http://localhost:5000/

    # Expected response
    {
      "message": "Authentication successful",
      "username": "testuser",
      "groups": ["admins", "users"],
      "email": "test@example.com"
    }
    ```
  </TabItem>
  <TabItem label="Check Headers">
    ```bash
    # Check for Authorization header
    curl -I -H "Remote-User: testuser" \
            -H "Remote-Groups: admins" \
            http://localhost:5000/

    # Expected headers
    HTTP/1.1 200 OK
    Authorization: Basic dGVzdHVzZXI6Z2VuZXJhdGVkLXBhc3N3b3Jk
    ```
  </TabItem>
  <TabItem label="Through Traefik">
    ```bash
    # Access Kibana through Traefik
    # (Assumes you're authenticated with Authelia)
    curl https://kibana.example.com/_cluster/health

    # Should return Elasticsearch cluster health
    ```
  </TabItem>
</Tabs>

## Troubleshooting

### Issue: 401 Unauthorized from elastauth

:::caution[Missing Authentication Headers]
elastauth logs show "missing authentication headers"
:::

**Solutions:**

<Steps>

1. Check Authelia headers are forwarded:
   ```yaml
   # In Traefik middleware
   authelia:
     forwardAuth:
       authResponseHeaders:
         - "Remote-User"
         - "Remote-Groups"
         - "Remote-Email"
         - "Remote-Name"
   ```

2. Verify middleware chain order:
   ```yaml
   auth-chain:
     chain:
       middlewares:
         - authelia  # Must be first
         - elastauth # Must be second
   ```

3. Check elastauth logs:
   ```bash
   docker logs elastauth
   ```

</Steps>

### Issue: Authorization header not forwarded

:::caution[Header Not Reaching Elasticsearch]
Elasticsearch returns 401, Authorization header missing
:::

**Solutions:**

<Steps>

1. Ensure elastauth middleware forwards Authorization header:
   ```yaml
   elastauth:
     forwardAuth:
       authResponseHeaders:
         - "Authorization"  # Must be present
   ```

2. Check Traefik logs:
   ```bash
   docker logs traefik
   ```

3. Verify header in response:
   ```bash
   curl -I -H "Remote-User: test" http://elastauth:5000/
   ```

</Steps>

### Issue: Elasticsearch user not created

:::danger[User Creation Failed]
User doesn't exist in Elasticsearch despite successful authentication
:::

**Solutions:**

<Steps>

1. Check Elasticsearch credentials:
   ```yaml
   elasticsearch:
     username: "elastic"  # Must have user management permissions
     password: "changeme"
   ```

2. Verify Elasticsearch connectivity:
   ```bash
   curl -u elastic:changeme https://elasticsearch:9200/_cluster/health
   ```

3. Check elastauth logs for errors:
   ```bash
   docker logs elastauth | grep -i error
   ```

4. Disable dry run mode:
   ```yaml
   elasticsearch:
     dry_run: false  # Must be false for user creation
   ```

</Steps>

### Issue: Cache not working

:::caution[Performance Issues]
Slow response times, high Elasticsearch load, new credentials every request
:::

**Solutions:**

<Steps>

1. Verify Redis connectivity:
   ```bash
   docker exec elastauth redis-cli -h redis ping
   ```

2. Check cache configuration:
   ```yaml
   cache:
     type: "redis"  # Not "memory" or empty
     redis_host: "redis:6379"
     expiration: "1h"
   ```

3. Check Redis logs:
   ```bash
   docker logs redis
   ```

</Steps>

### Issue: Traefik can't reach elastauth

:::danger[Connection Error]
502 Bad Gateway errors, Traefik logs show connection errors
:::

**Solutions:**

<Steps>

1. Verify network connectivity:
   ```bash
   docker exec traefik ping elastauth
   ```

2. Check service names match:
   ```yaml
   # In Traefik config
   address: "http://elastauth:5000/"  # Must match service name
   ```

3. Ensure services on same network:
   ```yaml
   # In docker-compose.yml
   services:
     traefik:
       networks:
         - elastauth-net
     elastauth:
       networks:
         - elastauth-net
   ```

</Steps>

## Performance Tuning

### Cache Optimization

```yaml
cache:
  type: "redis"
  expiration: "1h"  # Adjust based on security requirements
  redis_host: "redis:6379"
```

**Recommendations:**

<CardGrid>
  <Card title="High Security" icon="warning">
    15-30 minutes expiration
  </Card>
  <Card title="Balanced" icon="approve-check">
    1 hour (default)
  </Card>
  <Card title="Performance" icon="rocket">
    2-4 hours expiration
  </Card>
</CardGrid>

### Horizontal Scaling

Scale elastauth instances with Redis cache:

```yaml
services:
  elastauth:
    image: ghcr.io/wasilak/elastauth:latest
    deploy:
      replicas: 3  # Multiple instances
    environment:
      - ELASTAUTH_CACHE_TYPE=redis
      - ELASTAUTH_CACHE_REDIS_HOST=redis:6379
```

All instances share the same Redis cache for consistent credentials.

## Security Considerations

:::danger[Secret Key Security]
The secret key must be:
- Exactly 64 hexadecimal characters (32 bytes)
- Kept secret and secure
- Same across all instances when using Redis cache
:::

### Generate Secure Key

<Tabs syncKey="key-gen">
  <TabItem label="Using elastauth">
    ```bash
    elastauth --generateKey
    ```
  </TabItem>
  <TabItem label="Using OpenSSL">
    ```bash
    openssl rand -hex 32
    ```
  </TabItem>
</Tabs>

### Store Securely

```bash
# Store in environment variable
export ELASTAUTH_SECRET_KEY=$(openssl rand -hex 32)

# Use in docker-compose
environment:
  - ELASTAUTH_SECRET_KEY=${ELASTAUTH_SECRET_KEY}
```

## Next Steps

<CardGrid>
  <LinkCard
    title="OIDC Provider"
    description="Use OIDC instead of Authelia"
    href="/elastauth/providers/oidc/"
  />
  <LinkCard
    title="Redis Cache"
    description="Optimize Redis cache configuration"
    href="/elastauth/cache/redis/"
  />
  <LinkCard
    title="Troubleshooting"
    description="More solutions and common issues"
    href="/elastauth/guides/troubleshooting/"
  />
  <LinkCard
    title="Transparent Proxy Mode"
    description="Compare with proxy mode"
    href="/elastauth/deployment/proxy-mode/"
  />
</CardGrid>
